# Basic Spring Security

## Spring Class diagrams (to improve)

[![](https://mermaid.ink/img/eyJjb2RlIjoiY2xhc3NEaWFncmFtXG4gICAgXG4gICAgU2VyaWFsaXphYmxlIDx8LS0gVXNlckRldGFpbHNcblxuXG4gICAgY2xhc3MgU2VyaWFsaXphYmxlIHtcblxuICAgIH1cblxuICAgIGNsYXNzIFVzZXJEZXRhaWxze1xuICAgIDw8aW50ZXJmYWNlPj5cbiAgICBnZXRBdXRob3JpdGllcygpQ29sbGVjdGlvbiBleHRlbmRzR3JhbnRlZEF1dGhvcml0eVxuICAgIGdldFBhc3N3b3JkKClTdHJpbmdcbiAgICBnZXRVc2VybmFtZSgpU3RyaW5nXG4gICAgaXNBY2NvdW50Tm9uRXhwaXJlZCgpYm9vbGVhblxuICAgIGlzQWNjb3VudE5vbkxvY2tlZCgpYm9vbGVhblxuICAgIGlzQ3JlZGVudGlhbHNOb25FeHBpcmVkKClib29sZWFuXG4gICAgaXNFbmFibGVkKClib29sZWFuXG4gICAgfVxuXG4gICAgU2VyaWFsaXphYmxlIDx8LS0gR3JhbnRlZEF1dGhvcml0eVxuXG4gICAgY2xhc3MgR3JhbnRlZEF1dGhvcml0eXtcbiAgICBnZXRBdXRob3JpdHkoKVN0cmluZ1xuICAgIH1cblxuICAgIFVzZXJEZXRhaWxzIG8tLSBHcmFudGVkQXV0aG9yaXR5XG5cbiAgICBVc2VyRGV0YWlscyA8fC0tIFVzZXJcbiAgICBDcmVkZW50aWFsc0NvbnRhaW5lciA8fC0tIFVzZXJcbiAgICBcbiAgICBjbGFzcyBVc2Vye1xuICAgIHBhc3N3b3JkOlN0cmluZ1xuICAgIHVzZXJuYW1lOlN0cmluZ1xuICAgIGF1dGhvcml0aWVzOlNldDxHcmFudGVkQXV0aG9yaXR5PlxuICAgIGFjY291bnROb25FeHBpcmVkOmJvb2xlYW5cbiAgICBhY2NvdW50Tm9uTG9ja2VkOmJvb2xlYW5cbiAgICBjcmVkZW50aWFsc05vbkV4cGlyZWQ6Ym9vbGVhblxuICAgIGVuYWJsZWQ6Ym9vbGVhblxuICAgIGVyYXNlQ3JlZGVudGlhbCgpc2V0cyBwYXNzd29yZG51bGxcbiAgICB3aXRoVXNlcm5hbWUoKVVzZXJEb3RVc2VyQnVpbGRlclxuICAgIFVzZXJEb3RVc2VyQnVpbGRlcnVzZXJuYW1lKHVzZXJuYW1lKVVzZXJEb3RVc2VyQnVpbGRlclxuICAgIFVzZXJEb3RVc2VyQnVpbGRlcnBhc3N3b3JkKHBhc3N3b3JkKVVzZXJEb3RVc2VyQnVpbGRlclxuICAgIFVzZXJEb3RVc2VyQnVpbGRlcnBhc3N3b3JkRW5jb2RlcihGdW5jdGlvbjxTdHJpbmcsIFN0cmluZz5lbmNvZGVyKVVzZXJEb3RVc2VyQnVpbGRlclxuICAgIFVzZXJEb3RVc2VyQnVpbGRlcnJvbGVzKFN0cmluZy4uLnJvbGVzKVVzZXJEb3RVc2VyQnVpbGRlclxuICAgIGJ1aWxkKClVc2VyRGV0YWlsc1xuICAgIH1cblxuICAgIFVzZXIgby0tIEdyYW50ZWRBdXRob3JpdHlcbiAgICBcbiAgICBjbGFzcyBDcmVkZW50aWFsc0NvbnRhaW5lcntcbiAgICBlcmFzZUNyZWRlbnRpYWxzKCl2b2lkXG4gICAgfVxuXG4gICAgY2xhc3MgVXNlckRldGFpbHNNYW5hZ2Vye1xuICAgIDw8aW50ZXJmYWNlPj5cbiAgICBjcmVhdGVVc2VyKFVzZXJEZXRhaWxzIHZhcjEpdm9pZFxuICAgIHVwZGF0ZVVzZXIoVXNlckRldGFpbHMgdmFyMSl2b2lkXG4gICAgZGVsZXRlVXNlcihTdHJpbmcgdmFyMSl2b2lkXG4gICAgY2hhbmdlUGFzc3dvcmQoU3RyaW5nIHZhcjEsIFN0cmluZyB2YXIyKXZvaWRcbiAgICB1c2VyRXhpc3RzKFN0cmluZyB2YXIxKWJvb2xlYW5cbiAgICB9XG5cbiAgICBjbGFzcyBVc2VyRGV0YWlsc1NlcnZpY2V7XG4gICAgPDxpbnRlcmZhY2U-PlxuICAgIGxvYWRVc2VyQnlVc2VybmFtZSgpVXNlckRldGFpbHNcbiAgICB9XG5cbiAgICBVc2VyRGV0YWlsc1NlcnZpY2Ugby0tIFVzZXJEZXRhaWxzXG5cbiAgICBVc2VyRGV0YWlsc1NlcnZpY2UgPHwtLSBVc2VyRGV0YWlsc01hbmFnZXJcblxuICAgIFVzZXJEZXRhaWxzTWFuYWdlciA8LS0gSW5NZW1vcnlVc2VyRGV0YWlsc01hbmFnZXJcbiAgICBVc2VyRGV0YWlsc1Bhc3N3b3JkU2VydmljZSA8LS0gSW5NZW1vcnlVc2VyRGV0YWlsc01hbmFnZXJcblxuXG4gICAgQWJzdHJhY3RDb25maWd1cmVkU2VjdXJpdHlCdWlsZGVyIDx8LS0gQXV0aGVudGljYXRpb25NYW5hZ2VyQnVpbGRlclxuXG4gICAgY2xhc3MgQXV0aGVudGljYXRpb25NYW5hZ2VyQnVpbGRlcntcbiAgICBwYXJlbnRBdXRoZW50aWNhdGlvbk1hbmFnZXIoQXV0aGVudGljYXRpb25NYW5hZ2VyKTpBdXRoZW50aWNhdGlvbk1hbmFnZXJCdWlsZGVyXG4gICAgYXV0aGVudGljYXRpb25FdmVudFB1Ymxpc2hlcihBdXRoZW50aWNhdGlvbkV2ZW50UHVibGlzaGVyKUF1dGhlbnRpY2F0aW9uTWFuYWdlckJ1aWxkZXJcbiAgICBlcmFzZUNyZWRlbnRpYWxzKGJvb2xlYW4gZXJhc2VDcmVkZW50aWFscylBdXRoZW50aWNhdGlvbk1hbmFnZXJCdWlsZGVyXG4gICAgaW5NZW1vcnlBdXRoZW50aWNhdGlvbigpSW5NZW1vcnlVc2VyRGV0YWlsc01hbmFnZXJDb25maWd1cmVyX0F1dGhlbnRpY2F0aW9uTWFuYWdlckJ1aWxkZXJcbiAgICBqZGJjQXV0aGVudGljYXRpb24oKUpkYmNVc2VyRGV0YWlsc01hbmFnZXJDb25maWd1cmVyX0F1dGhlbnRpY2F0aW9uTWFuYWdlckJ1aWxkZXJcbiAgICB1c2VyRGV0YWlsc1NlcnZpY2UoVCB1c2VyRGV0YWlsc1NlcnZpY2UpXG4gICAgYXV0aGVudGljYXRpb25Qcm92aWRlcigpQXV0aGVudGljYXRpb25NYW5hZ2VyQnVpbGRlclxuICAgIHBlcmZvcm1CdWlsZCgpUHJvdmlkZXJNYW5hZ2VyXG4gICAgaXNDb25maWd1cmVkKClib29sZWFuXG4gICAgZ2V0RGVmYXVsdFVzZXJEZXRhaWxzU2VydmljZSgpVXNlckRldGFpbHNTZXJ2aWNlXG4gICAgYXBwbHkoKVVzZXJEZXRhaWxzQXdhcmVDb25maWd1cmVyXG4gICAgREVUQUlMX01PUkVfSEVSRS4uLlxuICAgIH1cblxuICAgIEF1dGhlbnRpY2F0aW9uTWFuYWdlckJ1aWxkZXIgby0tIFVzZXJEZXRhaWxzU2VydmljZSIsIm1lcm1haWQiOnt9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ)](https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiY2xhc3NEaWFncmFtXG4gICAgXG4gICAgU2VyaWFsaXphYmxlIDx8LS0gVXNlckRldGFpbHNcblxuXG4gICAgY2xhc3MgU2VyaWFsaXphYmxlIHtcblxuICAgIH1cblxuICAgIGNsYXNzIFVzZXJEZXRhaWxze1xuICAgIDw8aW50ZXJmYWNlPj5cbiAgICBnZXRBdXRob3JpdGllcygpQ29sbGVjdGlvbiBleHRlbmRzR3JhbnRlZEF1dGhvcml0eVxuICAgIGdldFBhc3N3b3JkKClTdHJpbmdcbiAgICBnZXRVc2VybmFtZSgpU3RyaW5nXG4gICAgaXNBY2NvdW50Tm9uRXhwaXJlZCgpYm9vbGVhblxuICAgIGlzQWNjb3VudE5vbkxvY2tlZCgpYm9vbGVhblxuICAgIGlzQ3JlZGVudGlhbHNOb25FeHBpcmVkKClib29sZWFuXG4gICAgaXNFbmFibGVkKClib29sZWFuXG4gICAgfVxuXG4gICAgU2VyaWFsaXphYmxlIDx8LS0gR3JhbnRlZEF1dGhvcml0eVxuXG4gICAgY2xhc3MgR3JhbnRlZEF1dGhvcml0eXtcbiAgICBnZXRBdXRob3JpdHkoKVN0cmluZ1xuICAgIH1cblxuICAgIFVzZXJEZXRhaWxzIG8tLSBHcmFudGVkQXV0aG9yaXR5XG5cbiAgICBVc2VyRGV0YWlscyA8fC0tIFVzZXJcbiAgICBDcmVkZW50aWFsc0NvbnRhaW5lciA8fC0tIFVzZXJcbiAgICBcbiAgICBjbGFzcyBVc2Vye1xuICAgIHBhc3N3b3JkOlN0cmluZ1xuICAgIHVzZXJuYW1lOlN0cmluZ1xuICAgIGF1dGhvcml0aWVzOlNldDxHcmFudGVkQXV0aG9yaXR5PlxuICAgIGFjY291bnROb25FeHBpcmVkOmJvb2xlYW5cbiAgICBhY2NvdW50Tm9uTG9ja2VkOmJvb2xlYW5cbiAgICBjcmVkZW50aWFsc05vbkV4cGlyZWQ6Ym9vbGVhblxuICAgIGVuYWJsZWQ6Ym9vbGVhblxuICAgIGVyYXNlQ3JlZGVudGlhbCgpc2V0cyBwYXNzd29yZG51bGxcbiAgICB3aXRoVXNlcm5hbWUoKVVzZXJEb3RVc2VyQnVpbGRlclxuICAgIFVzZXJEb3RVc2VyQnVpbGRlcnVzZXJuYW1lKHVzZXJuYW1lKVVzZXJEb3RVc2VyQnVpbGRlclxuICAgIFVzZXJEb3RVc2VyQnVpbGRlcnBhc3N3b3JkKHBhc3N3b3JkKVVzZXJEb3RVc2VyQnVpbGRlclxuICAgIFVzZXJEb3RVc2VyQnVpbGRlcnBhc3N3b3JkRW5jb2RlcihGdW5jdGlvbjxTdHJpbmcsIFN0cmluZz5lbmNvZGVyKVVzZXJEb3RVc2VyQnVpbGRlclxuICAgIFVzZXJEb3RVc2VyQnVpbGRlcnJvbGVzKFN0cmluZy4uLnJvbGVzKVVzZXJEb3RVc2VyQnVpbGRlclxuICAgIGJ1aWxkKClVc2VyRGV0YWlsc1xuICAgIH1cblxuICAgIFVzZXIgby0tIEdyYW50ZWRBdXRob3JpdHlcbiAgICBcbiAgICBjbGFzcyBDcmVkZW50aWFsc0NvbnRhaW5lcntcbiAgICBlcmFzZUNyZWRlbnRpYWxzKCl2b2lkXG4gICAgfVxuXG4gICAgY2xhc3MgVXNlckRldGFpbHNNYW5hZ2Vye1xuICAgIDw8aW50ZXJmYWNlPj5cbiAgICBjcmVhdGVVc2VyKFVzZXJEZXRhaWxzIHZhcjEpdm9pZFxuICAgIHVwZGF0ZVVzZXIoVXNlckRldGFpbHMgdmFyMSl2b2lkXG4gICAgZGVsZXRlVXNlcihTdHJpbmcgdmFyMSl2b2lkXG4gICAgY2hhbmdlUGFzc3dvcmQoU3RyaW5nIHZhcjEsIFN0cmluZyB2YXIyKXZvaWRcbiAgICB1c2VyRXhpc3RzKFN0cmluZyB2YXIxKWJvb2xlYW5cbiAgICB9XG5cbiAgICBjbGFzcyBVc2VyRGV0YWlsc1NlcnZpY2V7XG4gICAgPDxpbnRlcmZhY2U-PlxuICAgIGxvYWRVc2VyQnlVc2VybmFtZSgpVXNlckRldGFpbHNcbiAgICB9XG5cbiAgICBVc2VyRGV0YWlsc1NlcnZpY2Ugby0tIFVzZXJEZXRhaWxzXG5cbiAgICBVc2VyRGV0YWlsc1NlcnZpY2UgPHwtLSBVc2VyRGV0YWlsc01hbmFnZXJcblxuICAgIFVzZXJEZXRhaWxzTWFuYWdlciA8LS0gSW5NZW1vcnlVc2VyRGV0YWlsc01hbmFnZXJcbiAgICBVc2VyRGV0YWlsc1Bhc3N3b3JkU2VydmljZSA8LS0gSW5NZW1vcnlVc2VyRGV0YWlsc01hbmFnZXJcblxuXG4gICAgQWJzdHJhY3RDb25maWd1cmVkU2VjdXJpdHlCdWlsZGVyIDx8LS0gQXV0aGVudGljYXRpb25NYW5hZ2VyQnVpbGRlclxuXG4gICAgY2xhc3MgQXV0aGVudGljYXRpb25NYW5hZ2VyQnVpbGRlcntcbiAgICBwYXJlbnRBdXRoZW50aWNhdGlvbk1hbmFnZXIoQXV0aGVudGljYXRpb25NYW5hZ2VyKTpBdXRoZW50aWNhdGlvbk1hbmFnZXJCdWlsZGVyXG4gICAgYXV0aGVudGljYXRpb25FdmVudFB1Ymxpc2hlcihBdXRoZW50aWNhdGlvbkV2ZW50UHVibGlzaGVyKUF1dGhlbnRpY2F0aW9uTWFuYWdlckJ1aWxkZXJcbiAgICBlcmFzZUNyZWRlbnRpYWxzKGJvb2xlYW4gZXJhc2VDcmVkZW50aWFscylBdXRoZW50aWNhdGlvbk1hbmFnZXJCdWlsZGVyXG4gICAgaW5NZW1vcnlBdXRoZW50aWNhdGlvbigpSW5NZW1vcnlVc2VyRGV0YWlsc01hbmFnZXJDb25maWd1cmVyX0F1dGhlbnRpY2F0aW9uTWFuYWdlckJ1aWxkZXJcbiAgICBqZGJjQXV0aGVudGljYXRpb24oKUpkYmNVc2VyRGV0YWlsc01hbmFnZXJDb25maWd1cmVyX0F1dGhlbnRpY2F0aW9uTWFuYWdlckJ1aWxkZXJcbiAgICB1c2VyRGV0YWlsc1NlcnZpY2UoVCB1c2VyRGV0YWlsc1NlcnZpY2UpXG4gICAgYXV0aGVudGljYXRpb25Qcm92aWRlcigpQXV0aGVudGljYXRpb25NYW5hZ2VyQnVpbGRlclxuICAgIHBlcmZvcm1CdWlsZCgpUHJvdmlkZXJNYW5hZ2VyXG4gICAgaXNDb25maWd1cmVkKClib29sZWFuXG4gICAgZ2V0RGVmYXVsdFVzZXJEZXRhaWxzU2VydmljZSgpVXNlckRldGFpbHNTZXJ2aWNlXG4gICAgYXBwbHkoKVVzZXJEZXRhaWxzQXdhcmVDb25maWd1cmVyXG4gICAgREVUQUlMX01PUkVfSEVSRS4uLlxuICAgIH1cblxuICAgIEF1dGhlbnRpY2F0aW9uTWFuYWdlckJ1aWxkZXIgby0tIFVzZXJEZXRhaWxzU2VydmljZSIsIm1lcm1haWQiOnt9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ)
 

## Previous configuration

### Postgres configuration

1. Start postgres entities
```shell
$ cd postgres-entities
$ docker-compose up
```
2. Optionally you can enter the docker to check "users" table which will be created once spring is started:
```shell
$ docker exec -it your_docker_id sh
$ psql -h localhost -p 5432 -U jpatutorial -d springbootjpa
$ \c
$ \dt
$ SELECT * FROM users;
```

## How to Use

* Start the application
```shell script
mvn spring-boot:run
```

* Extract the password from the console:

```shell script
Using configured security password ==> password
```

* Setting environment variables:

```shell script
export USER=eum602
export PASSWORD=password # change this value accordingly, DO NOT COPY PASTE
```

* Extract message from hello controller with http ==> **comment** the following lines in application.propereties:

```shell script
#server.ssl.key-store-type=PKCS12
#server.ssl.key-store=certificate.p12
#server.ssl.key-store-password=12345678
```

```shell script
curl -u $USER:$PASSWORD http://localhost:8080/hello # Should obtain "hello"
```

* Obtaining an error because of unauthenticated user:

```shell script
curl http://localhost:8080/hello # should obtain ==>
 
{
  "timestamp": "2020-12-27T19:08:26.487+00:00",
  "status": 401,
  "error": "Unauthorized",
  "message": "",
  "path": "/hello"
}
```

* Authenticating using a header:

```shell script
encoded=`echo -n $USER:$PASSWORD | base64`
``` 

```shell script
curl -H "Authorization: Basic $encoded" localhost:8080/hello
```

## Configuring secure connection with https.

```shell script
cd certificate-generator
 ./1_create_private_key_and_pkcs12_public_certificate.sh # generates private key/pkcs12 public certificate => enter a password 12345678
./2_create_selfsigned_certificate.sh # generates selfsigned certificate
```

Update the password in src/main/resources/application.properties and uncomment the following:
```shell script
server.ssl.key-store-type=PKCS12
server.ssl.key-store=certificate.p12
server.ssl.key-store-password=12345678 #Update this password, do not copy-paste
```

## Accessing the hello controller

```shell script
curl -k -H "Authorization: Basic $encoded" https://localhost:8080/hello
```

```shell script
curl -k -u $USER:$PASSWORD https://localhost:8080/hello 
```

## Accessing the database information:

```shell script
curl -k -u $USER:$PASSWORD https://localhost:8080/users #only an example, this endpoint should NOT be exposed
```
